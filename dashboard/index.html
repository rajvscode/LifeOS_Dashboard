<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸŒ¿ LifeOS Dashboard</title>
  <meta name="theme-color" content="#00e676">
  <style>
    :root {--accent:#00e676;--bg:#0b0b0b;--card:#0f1510;--muted:#ccc;}
    body{background:var(--bg);color:#fff;font-family:"Segoe UI",sans-serif;margin:0;padding:20px;}
    h1{color:var(--accent);margin:0 0 8px 0;}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    button{background:var(--accent);color:#000;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .2s ease;}
    button.secondary{background:#222;color:#fff;border:1px solid #333;}
    button.pressed{transform:scale(0.98);opacity:0.8;}
    #status{color:var(--muted);margin-top:8px;}
    .container{display:flex;gap:20px;margin-top:18px;align-items:flex-start;}
    .left{flex:2;min-width:360px;}
    .right{flex:1;min-width:260px;}
    .progress-wrap{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 0 10px #000;}
    .progress-bar{height:12px;background:#222;border-radius:8px;overflow:hidden;}
    .progress-fill{height:12px;background:var(--accent);width:0%;transition:width .5s;}
    .task{background:linear-gradient(135deg,#101c10,#152419);padding:14px;margin:12px 0;border-radius:14px;display:flex;gap:12px;align-items:flex-start;box-shadow:0 0 12px #070707;opacity:0;transform:translateY(10px);animation:fadeIn .6s forwards;}
    .task-left{flex:1;}
    .task-right{flex:1;border-left:1px solid rgba(255,255,255,0.06);padding-left:12px;color:#ddd;font-size:0.9em;}
    .task .title{font-size:1.12em;font-weight:700;margin-bottom:6px;}
    .task .meta{color:#aaa;font-size:0.9em;margin-bottom:8px;}
    .task .buttons{display:flex;gap:8px;flex-wrap:wrap;}
    .btn-done{background:#28a745;color:#fff;}
    .btn-prog{background:#ffc107;color:#000;}
    .btn-miss{background:#d9534f;color:#fff;}
    .missed{background:linear-gradient(135deg,#3b0000,#661111);border:1px solid #aa4444;}
    .active{background:linear-gradient(135deg,#003000,#007a00);border:1px solid #00e676;box-shadow:0 0 15px rgba(0,255,150,0.25);}
    .small{font-size:0.9em;color:#ccc;}
    .toggle{display:flex;align-items:center;gap:8px;color:var(--accent);}
    #toast{position:fixed;right:20px;bottom:28px;background:#28a745;color:#fff;padding:12px 16px;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .3s ease;}
    #toast.show{opacity:1;pointer-events:auto;}
    @keyframes fadeIn{to{opacity:1;transform:translateY(0);}}
  </style>
</head>

<body>
  <div class="topbar">
    <div>
      <h1>ğŸŒ¿ LifeOS Dashboard</h1>
      <div id="status" class="small">âœ¨ Live consciously, act mindfully.</div>
    </div>
    <div class="controls">
      <label class="toggle"><input id="tomorrowToggle" type="checkbox"/> Show Tomorrowâ€™s Tasks ğŸŒ…</label>
      <button id="refreshBtn">ğŸ”„ Refresh</button>
      <button id="notifyBtn">ğŸ”” Enable Notifications</button>
    </div>
  </div>

  <div id="dateHeader" style="margin-top:10px;font-weight:600;color:var(--accent);"></div>
  <div id="nextHeader" style="margin-top:8px;color:var(--accent);font-weight:500;"></div>

  <div class="container">
    <div class="left">
      <div class="progress-wrap">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>ğŸ“… Daily Wellness Tracker</div>
          <div id="statsSummary" class="small">--</div>
        </div>
        <h3 style="margin:8px 0 8px 0">Today's Completion: <span id="percent">--</span></h3>
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      </div>
      <div id="tasksContainer" style="margin-top:12px;"></div>
    </div>

    <div class="right">
      <div class="small" style="color:#ff6b6b;font-weight:700;margin-bottom:8px;">âš ï¸ Missed Tasks</div>
      <div id="missedContainer" style="min-height:40px;"></div>
    </div>
  </div>

  <div id="toast"></div>

<script>
const API_ROOT="https://lifeos-full-dashboard.rajeshv-lifeos.workers.dev";
let tasks=[],tomorrow=false,nextCountdownInterval=null,lastAutoMissSync=0;

// --- Notifications ---
async function requestPermissions(){
 const btn=document.getElementById("notifyBtn");
 const current=localStorage.getItem("lifeosNotifyEnabled")==="true";
 if(current){
   localStorage.setItem("lifeosNotifyEnabled","false");
   btn.textContent="ğŸ”” Enable Notifications";
   btn.classList.remove("secondary");
   speak("Notifications turned off for now."); showToast("ğŸ”• Notifications disabled");
   return;
 }
 try{
   const p=await Notification.requestPermission();
   if(p==="granted"){
     localStorage.setItem("lifeosNotifyEnabled","true");
     btn.textContent="ğŸ”• Disable Notifications"; btn.classList.add("secondary");
     const quotes=[
       "Breathe deeply â€” each moment is a new start.",
       "Consistency builds strength â€” one task at a time.",
       "Stillness sharpens focus, clarity brings peace.",
       "Every mindful act adds to your health.",
       "You are closer than you think â€” keep going."
     ];
     speak("Notifications enabled. "+quotes[new Date().getDate()%quotes.length]);
     showToast("âœ… Notifications enabled");
   } else showToast("âš ï¸ Notifications blocked");
 }catch(e){console.error(e);showToast("âš ï¸ Notification error");}
}

function showToast(msg,bg="#28a745"){const t=document.getElementById("toast");t.textContent=msg;t.style.background=bg;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),3500);}
function speak(txt){try{const u=new SpeechSynthesisUtterance(txt);u.lang="en-IN";speechSynthesis.cancel();speechSynthesis.speak(u);}catch(e){console.error(e);}}

// --- Load Tasks ---
async function loadTasks(){
 document.getElementById("status").textContent="ğŸ§  Checking tasks...";
 const q=tomorrow?"?tomorrow=1":"";
 try{
   const res=await fetch(`${API_ROOT}/tasks${q}`,{cache:"no-store"});
   const data=await res.json();
   if(!data.tasks) throw new Error("No tasks found");
   tasks=data.tasks||[];
   render();
 }catch(err){console.error("Task fetch failed:",err);showToast("âŒ Failed to load tasks","#dc3545");}
}

// --- Helper functions ---
function formatTimeNoSeconds(t){if(!t)return"";const m=t.trim().match(/^(\d{1,2}):(\d{2})(?::\d{2})?\s*(am|pm)?$/i);if(m){let[h,min,ap]=[Number(m[1]),m[2],(m[3]||"").toLowerCase()];if(!ap){ap=h>=12?"pm":"am";if(h>12)h-=12;if(h===0)h=12;}return`${String(h).padStart(2,"0")}:${min} ${ap}`;}return t;}
function convertTo24h(t){const m=t.trim().match(/^(\d{1,2}):(\d{2})(?::\d{2})?\s*(am|pm)?$/i);if(!m)return"00:00";let[hh,mm,ap]=[Number(m[1]),m[2],(m[3]||"").toLowerCase()];if(ap==="pm"&&hh<12)hh+=12;if(ap==="am"&&hh===12)hh=0;return`${String(hh).padStart(2,"0")}:${mm}`;}
function escapeHtml(s){return s?s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"):"";}

// --- Countdown ---
function startNextCountdown(next){if(nextCountdownInterval)clearInterval(nextCountdownInterval);const head=document.getElementById("nextHeader");if(!next){head.textContent="";return;}function update(){const now=new Date();const parts=next.date.split(/[\/\-]/);const yyyy=parts[2].length===4?parts[2]:parts[0];const mm=parts[1].padStart(2,"0");const dd=parts[0].padStart(2,"0");const target=new Date(`${yyyy}-${mm}-${dd}T${convertTo24h(next.start)}:00+05:30`);const diff=target-now;if(diff<=0){head.textContent=`ğŸ•’ Current: ${next.task} (${formatTimeNoSeconds(next.start)})`;return;}const mins=Math.floor(diff/60000);const hrs=Math.floor(mins/60);const mLeft=mins%60;head.textContent=`ğŸ•’ Next: ${next.task} (${formatTimeNoSeconds(next.start)}) â€¢ â³ ${hrs>0?`${hrs}h ${mLeft}m`:`${mLeft}m`}`;if(mins===5&&localStorage.getItem("lifeosNotifyEnabled")==="true"){new Notification("ğŸŒ¿ Upcoming Task",{body:`${next.task} in 5 minutes.`});speak(`${next.task} starts in 5 minutes.`);}}update();nextCountdownInterval=setInterval(update,30000);}

// --- Render ---
function render() {
  const cont = document.getElementById("tasksContainer");
  const missedCont = document.getElementById("missedContainer");
  if (!cont || !missedCont) return;
  cont.innerHTML = "";
  missedCont.innerHTML = "";

  if (!tasks || tasks.length === 0) {
    cont.innerHTML = "<p>ğŸŒ¿ No upcoming tasks found.</p>";
    document.getElementById("percent").textContent = "--";
    document.getElementById("statsSummary").textContent = "--";
    document.getElementById("nextHeader").textContent = "";
    return;
  }

  // --- Filter out Done tasks from display ---
  const visibleTasks = tasks.filter(t => (t.status || "").toLowerCase() !== "done");

  // --- Header date ---
  const showDate = tasks[0]?.date || "";
  document.getElementById("dateHeader").textContent =
    tomorrow ? `ğŸ“… Showing Tomorrow's Tasks â€” ${showDate}` :
               `ğŸ“… Showing Today's Tasks â€” ${showDate}`;

  let doneCount = 0, missedCount = 0, progCount = 0, pendingCount = 0;
  const now = new Date();
  const nowM = now.getHours() * 60 + now.getMinutes();
  const autoMissedKeys = [];

  // --- Accurate counters from all tasks ---
  tasks.forEach(t => {
    const st = (t.status || "").toLowerCase();
    if (st === "done") doneCount++;
    else if (st === "missed") missedCount++;
    else if (st.includes("progress")) progCount++;
    else pendingCount++;
  });

  // --- Render visible tasks & detect missed ---
  visibleTasks.forEach(t => {
    let st = (t.status || "").toLowerCase();
    const [sh, sm] = convertTo24h(t.start).split(":").map(Number);
    const [eh, em] = convertTo24h(t.end).split(":").map(Number);
    const startM = sh * 60 + sm;
    const endM = eh * 60 + em;

    // Auto-mark missed (only for today, not tomorrow)
    if (!tomorrow && nowM > endM && !["done", "missed"].includes(st)) {
      st = "missed";
      autoMissedKeys.push(t.key);
    }

    const card = document.createElement("div");
    card.className = "task";
    if (st === "missed") card.classList.add("missed");
    if (nowM >= startM && nowM <= endM) card.classList.add("active");

    const left = document.createElement("div");
    left.className = "task-left";
    left.innerHTML = `
      <div class="title">${escapeHtml(t.task)}</div>
      <div class="meta">ğŸ•’ ${formatTimeNoSeconds(t.start)} - ${formatTimeNoSeconds(t.end)} â€¢ ${t.date}</div>
      <div class="buttons"></div>`;

    const right = document.createElement("div");
    right.className = "task-right";
    right.innerHTML = `
      <div class="small"><b>ğŸ“‚ Category:</b> ${escapeHtml(t.category || "General")}</div>
      <div class="small">ğŸ†” Key: ${escapeHtml(t.key || "")}</div>
      <div style="margin-top:8px">${escapeHtml(t.description || t.notes || "")}</div>`;

    const buttons = left.querySelector(".buttons");
    if (st === "missed") {
      buttons.innerHTML = `<button class="btn-done" onclick="pressAndUpdate(this,'${encodeURIComponent(t.key)}','Done')">âœ… Done</button>`;
      missedCont.appendChild(card);
    } else {
      buttons.innerHTML = `
        <button class="btn-done" onclick="pressAndUpdate(this,'${encodeURIComponent(t.key)}','Done')">âœ… Done</button>
        <button class="btn-prog" onclick="pressAndUpdate(this,'${encodeURIComponent(t.key)}','In Progress')">ğŸ”„ Progress</button>
        <button class="btn-miss" onclick="pressAndUpdate(this,'${encodeURIComponent(t.key)}','Missed')">âŒ Missed</button>`;
      cont.appendChild(card);
    }

    card.appendChild(left);
    card.appendChild(right);
  });

  // --- Stats display ---
  const total = Math.max(tasks.length, 1);
  const percent = Math.round((doneCount / total) * 100);
  document.getElementById("percent").textContent = `${percent}%`;
  document.getElementById("progressFill").style.width = `${percent}%`;
  document.getElementById("statsSummary").textContent =
    `âœ… Done: ${doneCount} â€¢ âš ï¸ Missed: ${missedCount} â€¢ ğŸ”„ InProg: ${progCount} â€¢ â³ Pending: ${pendingCount}`;

  // --- Next task countdown ---
  const next = visibleTasks.find(t => !["missed"].includes((t.status || "").toLowerCase()));
  startNextCountdown(next);

  // --- Auto-sync missed (every 30 min only, for today's tasks) ---
  const nowTs = Date.now();
  if (!tomorrow && autoMissedKeys.length > 0 && nowTs - lastAutoMissSync > 30 * 60 * 1000) {
    lastAutoMissSync = nowTs;
    autoMissedKeys.forEach(k => updateStatus(encodeURIComponent(k), "Missed"));
    console.log("Auto-synced missed:", autoMissedKeys);
  }
}

function pressAndUpdate(btn,keyEncoded,status){btn.classList.add("pressed");setTimeout(()=>btn.classList.remove("pressed"),400);updateStatus(keyEncoded,status,btn);}
async function updateStatus(keyEncoded,status,btnEl){const key=decodeURIComponent(keyEncoded);try{const url=`${API_ROOT}/update?action=updateStatusAndSyncBackupV82&taskKey=${encodeURIComponent(key)}&status=${encodeURIComponent(status)}`;const res=await fetch(url);if(!res.ok)showToast("âŒ Update failed","#dc3545");else{showToast("âœ… Updated: "+status);await new Promise(r=>setTimeout(r,700));await loadTasks();}}catch(err){console.error(err);showToast("âŒ Update error","#dc3545");}}

document.addEventListener("DOMContentLoaded",()=>{console.log("ğŸŒ¿ LifeOS Dashboard initialized successfully.");const btn=document.getElementById("notifyBtn");if(localStorage.getItem("lifeosNotifyEnabled")==="true"){btn.textContent="ğŸ”• Disable Notifications";btn.classList.add("secondary");}document.getElementById("refreshBtn").addEventListener("click",loadTasks);document.getElementById("tomorrowToggle").addEventListener("change",e=>{tomorrow=e.target.checked;loadTasks();});btn.addEventListener("click",requestPermissions);loadTasks();setInterval(loadTasks,5*60*1000);});
</script>
</body>
</html>
